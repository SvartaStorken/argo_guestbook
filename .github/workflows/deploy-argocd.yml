name: Deploy ArgoCD Application

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/deploy-argocd.yml'

jobs:
  deploy-argo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ArgoCD CLI
        uses: imajeetyadav/argocd-cli@v1
        with:
          version: latest

      - name: Create/Update ArgoCD Application
        env:
          ARGOCD_SERVER: openshift-gitops-server-openshift-gitops.apps.devops24.cloud2.se
          ARGOCD_PASSWORD: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          # Logga in i ArgoCD med admin-anv√§ndaren
          argocd login $ARGOCD_SERVER --username admin --password "$ARGOCD_PASSWORD" --insecure --grpc-web --skip-test-tls

          # Skapa eller uppdatera applikationen
          argocd app create mw-guestbook \
            --repo https://github.com/SvartaStorken/argo_guestbook.git \
            --path k8s \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace grupp2 \
            --project default \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert