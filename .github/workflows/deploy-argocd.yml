name: Deploy ArgoCD Application

on:
  push:
    branches:
      - main
    paths:
      - 'templates/argo-app-guestbook.yaml' # Triggar bara när argo-inställningen ändras
      - '.github/workflows/deploy-argocd.yml'

env:
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}

jobs:
  deploy-argo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install oc CLI
        uses: redhat-actions/oc-installer@v1.2

      - name: Install ArgoCD CLI
        uses: imajeetyadav/argocd-cli@v1
        with:
          version: latest

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1.3
        with:
          openshift_server_url: ${{ env.OPENSHIFT_SERVER }}
          openshift_token: ${{ env.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true

      - name: Create/Update ArgoCD Application
        env:
          ARGOCD_SERVER: openshift-gitops-server-openshift-gitops.apps.devops24.cloud2.se
        run: |
          # Hämta admin-lösenordet från OpenShift (SSO fungerar ej i CI utan webbläsare)
          ARGOCD_PASSWORD=$(oc get secret openshift-gitops-cluster -n openshift-gitops -o jsonpath='{.data.admin\.password}' | base64 -d)

          # Logga in i ArgoCD med admin-användaren
          argocd login $ARGOCD_SERVER --username admin --password "$ARGOCD_PASSWORD" --insecure --grpc-web --skip-test-tls

          # Skapa eller uppdatera applikationen
          argocd app create mw-guestbook \
            --repo https://github.com/SvartaStorken/argo_guestbook.git \
            --path k8s \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace grupp2 \
            --project default \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert