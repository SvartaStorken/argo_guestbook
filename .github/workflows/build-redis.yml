name: Build and Push Redis to Quay

on:
  push:
    branches:
      - main
    paths:
      - 'images/**'
      - '.github/workflows/build-redis.yml' # Bra att ha med om du ändrar i pipelinen

env:
  REGISTRY_QUAY: quay.io
  REGISTRY_RH: registry.redhat.io
  IMAGE_NAME: eksta_mannen/redis-argo 

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # VIKTIGT: Ger GitHub tillåtelse att skriva tillbaka ändringar i din k8s-fil
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Logga in på Red Hat
      - name: Log in to Red Hat Registry
        uses: redhat-actions/podman-login@v1.7
        with:
          registry: ${{ env.REGISTRY_RH }}
          username: ${{ secrets.RH_USERNAME }}
          password: ${{ secrets.RH_PASSWORD }}

      # 2. Logga in på Quay.io
      - name: Log in to Quay.io
        uses: redhat-actions/podman-login@v1.7
        with:
          registry: ${{ env.REGISTRY_QUAY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      # 3. Bygg imagen med BÅDE latest och SHA-tagg
      - name: Build Redis Image
        id: build-image
        uses: redhat-actions/buildah-build@v2.13
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: latest ${{ github.sha }} # <--- Här lägger vi till SHA
          context: ./images
          containerfiles: ./images/Containerfile

      # 4. Pusha BÅDA taggarna till Quay
      - name: Push to Quay.io
        uses: redhat-actions/push-to-registry@v2.8
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: latest ${{ github.sha }} # <--- Pusha båda
          registry: ${{ env.REGISTRY_QUAY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      # 5. MAGIN: Uppdatera din k8s/redis-quay.yaml med det nya SHA-värdet
      - name: Update image tag in K8s manifest
        uses: mikefarah/yq@v4.44.1
        with:
          cmd: yq -i '.spec.template.spec.containers[0].image = "quay.io/eksta_mannen/redis-argo:${{ github.sha }}"' k8s/redis-quay.yaml

      # 6. SKICKA TILLBAKA: Committa ändringen till Git
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/redis-quay.yaml
          # [skip ci] gör att GitHub inte startar ett nytt bygge när den ser sin egen ändring
          git commit -m "chore: update redis image to ${{ github.sha }} [skip ci]"
          git push