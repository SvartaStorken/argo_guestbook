name: Deploy Secrets to OpenShift

on:
  push:
    branches:
      - main
    paths:
      - 'templates/**'
      - '.github/workflows/deploy-secrets.yml'

env:
  # Se till att dessa namn matchar dina Repository Secrets i GitHub
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  OPENSHIFT_NAMESPACE: grupp2  # Ändra om du byter projekt

jobs:
  deploy-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install oc CLI
        uses: redhat-actions/oc-installer@v1.2

      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1.3
        with:
          openshift_server_url: ${{ env.OPENSHIFT_SERVER }}
          openshift_token: ${{ env.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.OPENSHIFT_NAMESPACE }}

      - name: Inject secrets and apply
        env:
          # Här mappar vi dina värden till variablerna i YAML-filen
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          # envsubst ersätter $DB_USER osv i filen med värdena ovan
          # Sedan pipe:as resultatet direkt till oc apply utan att sparas på disk
          cat templates/mw-secrets.yaml | envsubst | oc apply -f -
