name: Build and Push Postgres to Quay

on:
  push:
    branches:
      - main
    paths:
      - 'images/postgres/**'
      - '.github/workflows/build-postgres.yml'

env:
  REGISTRY_QUAY: quay.io
  REGISTRY_RH: registry.redhat.io
  IMAGE_NAME: eksta_mannen/postgres-argo 

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Red Hat Registry
        uses: redhat-actions/podman-login@v1.7
        with:
          registry: ${{ env.REGISTRY_RH }}
          username: ${{ secrets.RH_USERNAME }}
          password: ${{ secrets.RH_PASSWORD }}

      - name: Log in to Quay.io
        uses: redhat-actions/podman-login@v1.7
        with:
          registry: ${{ env.REGISTRY_QUAY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Build Postgres Image
        id: build-image
        uses: redhat-actions/buildah-build@v2.13
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: latest ${{ github.sha }}
          context: ./images/postgres
          containerfiles: ./images/postgres/Containerfile

      - name: Push to Quay.io
        uses: redhat-actions/push-to-registry@v2.8
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: latest ${{ github.sha }}
          registry: ${{ env.REGISTRY_QUAY }}
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}

      # VIKTIGT: Här uppdaterar vi postgres-filen istället för redis-filen
      - name: Update image tag in K8s manifest
        uses: mikefarah/yq@v4.44.1
        with:
          cmd: yq -i '.spec.template.spec.containers[0].image = "quay.io/eksta_mannen/postgres-argo:${{ github.sha }}"' k8s/mw-postgres-deployment.yaml

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/mw-postgres-deployment.yaml
          git commit -m "chore: update postgres image to ${{ github.sha }} [skip ci]"
          git push